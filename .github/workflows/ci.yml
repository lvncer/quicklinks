name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build & test (${{ matrix.service }})
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

    strategy:
      matrix:
        service: [web, extension, api]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        if: matrix.service != 'api'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.3'

      - name: Setup Go
        if: matrix.service == 'api'
        uses: actions/setup-go@v5
        with:
          go-version-file: api/go.mod

      # JS/TS dependencies (Bun, frozen lockfile)
      - name: Install root JS deps
        if: matrix.service != 'api'
        run: bun install --frozen-lockfile

      - name: Install web deps
        if: matrix.service == 'web'
        working-directory: web
        run: bun install --frozen-lockfile

      - name: Install extension deps
        if: matrix.service == 'extension'
        working-directory: extension
        run: bun install --frozen-lockfile

      # Web: lint / build / audit
      - name: Lint web
        if: matrix.service == 'web'
        working-directory: web
        run: bun run lint

      - name: Build web
        if: matrix.service == 'web'
        working-directory: web
        run: bun run build

      - name: Audit web dependencies
        if: matrix.service == 'web'
        working-directory: web
        run: bun audit --audit-level=high

      # Extension: build / audit (no dedicated lint script yet)
      - name: Build extension
        if: matrix.service == 'extension'
        working-directory: extension
        run: bun run build

      - name: Audit extension dependencies
        if: matrix.service == 'extension'
        working-directory: extension
        run: bun audit --audit-level=high

      # API (Go): fmt / test / build
      - name: Go fmt
        if: matrix.service == 'api'
        working-directory: api
        run: go fmt ./...

      - name: Go test
        if: matrix.service == 'api'
        working-directory: api
        run: go test ./...

      - name: Go build
        if: matrix.service == 'api'
        working-directory: api
        run: go build ./cmd/server
